<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸‰åŒäº‹é»‘æ‰‡å­ | ä¸‰å…ƒç„ç©ºä¹è¿çœŸè§£</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- HTML2Canvas & jsPDF for Real PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700;900&family=Noto+Sans+SC:wght@300;400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: #f5f5f4;
            color: #1c1917;
        }
        
        .serif { font-family: 'Noto Serif SC', serif; }

        .ink-bg { background-color: #0f172a; }
        .ink-text { color: #0f172a; }

        /* Grid Overlay Styles */
        .grid-overlay {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            border: 2px solid rgba(15, 23, 42, 0.9);
            z-index: 10;
        }
        .grid-cell {
            border: 1px dashed rgba(15, 23, 42, 0.3);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            pointer-events: auto;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            backdrop-filter: blur(1px);
        }
        .grid-cell:hover {
            background-color: rgba(255, 255, 255, 0.6);
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
        }
        
        /* Flying Star Numbers Layout */
        .star-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            width: 100%;
            height: 100%;
            padding: 2px;
        }
        .star-sitting { /* Top Left - Mountain */
            grid-area: 1 / 1 / 2 / 2;
            text-align: left;
            padding-left: 4px;
            font-size: 0.8rem;
            font-weight: bold;
            color: #1e3a8a; /* Blue */
        }
        .star-facing { /* Top Right - Facing */
            grid-area: 1 / 2 / 2 / 3;
            text-align: right;
            padding-right: 4px;
            font-size: 0.8rem;
            font-weight: bold;
            color: #b91c1c; /* Red */
        }
        .star-base { /* Center - Period */
            grid-area: 2 / 1 / 3 / 3;
            text-align: center;
            font-size: 1.2rem;
            font-weight: 900;
            color: #0f172a;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            opacity: 0.6;
        }

        /* Loading Spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0f172a;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ç„ç©ºæ•°æ®æ ¸å¿ƒ (Period 9 Logic) ---

        const PALACES = [
            { id: "NW", name: "è¥¿åŒ— (ä¹¾)", type: "é‡‘", base9: 1 }, 
            { id: "N",  name: "æ­£åŒ— (å)", type: "æ°´", base9: 5 },
            { id: "NE", name: "ä¸œåŒ— (è‰®)", type: "åœŸ", base9: 3 },
            { id: "W",  name: "æ­£è¥¿ (å…‘)", type: "é‡‘", base9: 2 },
            { id: "C",  name: "ä¸­å®«",      type: "åœŸ", base9: 9 },
            { id: "E",  name: "æ­£ä¸œ (éœ‡)", type: "æœ¨", base9: 7 },
            { id: "SW", name: "è¥¿å— (å¤)", type: "åœŸ", base9: 6 },
            { id: "S",  name: "æ­£å— (ç¦»)", type: "ç«", base9: 4 },
            { id: "SE", name: "ä¸œå— (å·½)", type: "æœ¨", base9: 8 }
        ];

        // 24 Mountains with Updated Labels for better user experience
        const MOUNTAINS_24 = [
            // North (Kan)
            { name: "ååŒ—æœå— (å£¬å±±ä¸™å‘)", period9Chart: [2, 5, 7, 3, 9, 7, 9, 4, 3, 4, 8, 2, 6, 1, 6, 1, 6, 1, 8, 2, 8, 7, 3, 5, 5, 1, 4] },
            { name: "ååŒ—æœå— (å­å±±åˆå‘)", period9Chart: [1, 6, 2, 9, 5, 7, 8, 1, 9, 2, 7, 3, 6, 2, 5, 5, 9, 1, 7, 3, 4, 3, 8, 8, 4, 4, 6] },
            { name: "ååŒ—æœå— (ç™¸å±±ä¸å‘)", period9Chart: [1, 6, 2, 9, 5, 7, 8, 1, 9, 2, 7, 3, 6, 2, 5, 5, 9, 1, 7, 3, 4, 3, 8, 8, 4, 4, 6] },
            // NE (Gen)
            { name: "åä¸œåŒ—æœè¥¿å— (ä¸‘å±±æœªå‘)", period9Chart: [6, 2, 3, 2, 7, 8, 4, 9, 1, 5, 3, 4, 1, 8, 6, 9, 4, 2, 8, 6, 5, 7, 5, 9, 3, 1, 7] },
            { name: "åä¸œåŒ—æœè¥¿å— (è‰®å±±å¤å‘)", period9Chart: [9, 5, 3, 5, 1, 8, 7, 6, 1, 8, 6, 4, 4, 2, 6, 3, 7, 2, 2, 9, 5, 1, 8, 9, 6, 4, 7] },
            { name: "åä¸œåŒ—æœè¥¿å— (å¯…å±±ç”³å‘)", period9Chart: [9, 5, 3, 5, 1, 8, 7, 6, 1, 8, 6, 4, 4, 2, 6, 3, 7, 2, 2, 9, 5, 1, 8, 9, 6, 4, 7] },
            // East (Zhen)
            { name: "åä¸œæœè¥¿ (ç”²å±±åºšå‘)", period9Chart: [6, 1, 4, 2, 6, 9, 4, 8, 2, 5, 2, 5, 1, 5, 7, 9, 9, 3, 8, 4, 6, 7, 3, 1, 3, 7, 8] },
            { name: "åä¸œæœè¥¿ (å¯å±±é…‰å‘)", period9Chart: [5, 2, 4, 1, 7, 9, 3, 9, 2, 4, 3, 5, 9, 6, 7, 8, 1, 3, 7, 5, 6, 6, 4, 1, 2, 8, 8] },
            { name: "åä¸œæœè¥¿ (ä¹™å±±è¾›å‘)", period9Chart: [5, 2, 4, 1, 7, 9, 3, 9, 2, 4, 3, 5, 9, 6, 7, 8, 1, 3, 7, 5, 6, 6, 4, 1, 2, 8, 8] },
            // SE (Xun)
            { name: "åä¸œå—æœè¥¿åŒ— (è¾°å±±æˆŒå‘)", period9Chart: [7, 5, 5, 3, 9, 1, 5, 7, 3, 6, 4, 6, 2, 8, 8, 1, 3, 4, 9, 1, 7, 8, 2, 2, 4, 6, 9] },
            { name: "åä¸œå—æœè¥¿åŒ— (å·½å±±ä¹¾å‘)", period9Chart: [4, 8, 5, 9, 4, 1, 2, 6, 3, 3, 7, 6, 8, 2, 8, 7, 9, 4, 6, 5, 7, 5, 1, 2, 1, 3, 9] },
            { name: "åä¸œå—æœè¥¿åŒ— (å·³å±±äº¥å‘)", period9Chart: [4, 8, 5, 9, 4, 1, 2, 6, 3, 3, 7, 6, 8, 2, 8, 7, 9, 4, 6, 5, 7, 5, 1, 2, 1, 3, 9] },
            // South (Li)
            { name: "åå—æœåŒ— (ä¸™å±±å£¬å‘)", period9Chart: [7, 4, 6, 3, 8, 2, 5, 6, 4, 6, 3, 5, 2, 7, 9, 1, 2, 1, 8, 9, 7, 9, 1, 3, 4, 5, 8] },
            { name: "åå—æœåŒ— (åˆå±±å­å‘)", period9Chart: [8, 3, 7, 4, 8, 3, 6, 1, 5, 7, 2, 6, 3, 7, 9, 2, 5, 1, 1, 9, 8, 9, 4, 4, 5, 6, 2] },
            { name: "åå—æœåŒ— (ä¸å±±ç™¸å‘)", period9Chart: [8, 3, 7, 4, 8, 3, 6, 1, 5, 7, 2, 6, 3, 7, 9, 2, 5, 1, 1, 9, 8, 9, 4, 4, 5, 6, 2] },
            // SW (Kun)
            { name: "åè¥¿å—æœä¸œåŒ— (æœªå±±ä¸‘å‘)", period9Chart: [3, 8, 7, 8, 4, 3, 1, 6, 5, 2, 7, 6, 6, 3, 9, 5, 1, 1, 9, 5, 8, 4, 9, 2, 7, 2, 4] },
            { name: "åè¥¿å—æœä¸œåŒ— (å¤å±±è‰®å‘)", period9Chart: [3, 8, 7, 8, 4, 3, 1, 6, 5, 2, 7, 6, 6, 3, 9, 5, 1, 1, 9, 5, 8, 4, 9, 2, 7, 2, 4] },
            { name: "åè¥¿å—æœä¸œåŒ— (ç”³å±±å¯…å‘)", period9Chart: [3, 8, 7, 8, 4, 3, 1, 6, 5, 2, 7, 6, 6, 3, 9, 5, 1, 1, 9, 5, 8, 4, 9, 2, 7, 2, 4] },
            // West (Dui)
            { name: "åè¥¿æœä¸œ (åºšå±±ç”²å‘)", period9Chart: [1, 6, 8, 5, 1, 4, 3, 8, 6, 2, 5, 7, 6, 9, 2, 4, 2, 1, 8, 4, 9, 9, 7, 3, 7, 3, 5] },
            { name: "åè¥¿æœä¸œ (é…‰å±±å¯å‘)", period9Chart: [2, 5, 8, 6, 1, 4, 4, 9, 6, 3, 4, 7, 1, 8, 2, 8, 6, 1, 9, 3, 9, 5, 7, 3, 7, 2, 5] },
            { name: "åè¥¿æœä¸œ (è¾›å±±ä¹™å‘)", period9Chart: [2, 5, 8, 6, 1, 4, 4, 9, 6, 3, 4, 7, 1, 8, 2, 8, 6, 1, 9, 3, 9, 5, 7, 3, 7, 2, 5] },
            // NW (Qian)
            { name: "åè¥¿åŒ—æœä¸œå— (æˆŒå±±è¾°å‘)", period9Chart: [5, 7, 9, 1, 3, 5, 3, 5, 7, 4, 6, 8, 9, 2, 4, 8, 1, 6, 2, 9, 2, 6, 4, 1, 7, 8, 3] },
            { name: "åè¥¿åŒ—æœä¸œå— (ä¹¾å±±å·½å‘)", period9Chart: [8, 4, 9, 4, 9, 5, 6, 2, 7, 7, 3, 8, 3, 8, 4, 2, 7, 6, 1, 6, 2, 9, 5, 1, 5, 1, 3] },
            { name: "åè¥¿åŒ—æœä¸œå— (äº¥å±±å·³å‘)", period9Chart: [8, 4, 9, 4, 9, 5, 6, 2, 7, 7, 3, 8, 3, 8, 4, 2, 7, 6, 1, 6, 2, 9, 5, 1, 5, 1, 3] }
        ];

        const ZODIACS = [
            { name: "é¼ ", element: "æ°´", clash: "æ­£å— (åˆ)", friendly: "çŒ´ã€é¾™", noble: "è¥¿å—ã€ä¸œå—", peach: "æ­£è¥¿", wenchang: "æ­£ä¸œ" },
            { name: "ç‰›", element: "åœŸ", clash: "è¥¿å— (æœª)", friendly: "è›‡ã€é¸¡", noble: "æ­£åŒ—ã€æ­£è¥¿", peach: "æ­£å—", wenchang: "æ­£å—" },
            { name: "è™", element: "æœ¨", clash: "è¥¿å— (ç”³)", friendly: "é©¬ã€ç‹—", noble: "è¥¿åŒ—ã€æ­£å—", peach: "æ­£ä¸œ", wenchang: "æ­£ä¸œ" },
            { name: "å…”", element: "æœ¨", clash: "æ­£è¥¿ (é…‰)", friendly: "çŒªã€ç¾Š", noble: "è¥¿åŒ—ã€æ­£åŒ—", peach: "æ­£åŒ—", wenchang: "æ­£å—" },
            { name: "é¾™", element: "åœŸ", clash: "è¥¿åŒ— (æˆŒ)", friendly: "é¼ ã€çŒ´", noble: "æ­£è¥¿ã€æ­£åŒ—", peach: "æ­£è¥¿", wenchang: "è¥¿å—" },
            { name: "è›‡", element: "ç«", clash: "è¥¿åŒ— (äº¥)", friendly: "é¸¡ã€ç‰›", noble: "è¥¿å—ã€æ­£è¥¿", peach: "æ­£å—", wenchang: "æ­£è¥¿" },
            { name: "é©¬", element: "ç«", clash: "æ­£åŒ— (å­)", friendly: "è™ã€ç‹—", noble: "è¥¿åŒ—ã€ä¸œåŒ—", peach: "æ­£ä¸œ", wenchang: "è¥¿å—" },
            { name: "ç¾Š", element: "åœŸ", clash: "ä¸œåŒ— (ä¸‘)", friendly: "å…”ã€çŒª", noble: "æ­£å—ã€æ­£ä¸œ", peach: "æ­£åŒ—", wenchang: "æ­£è¥¿" },
            { name: "çŒ´", element: "é‡‘", clash: "ä¸œåŒ— (å¯…)", friendly: "é¼ ã€é¾™", noble: "ä¸œåŒ—ã€ä¸œå—", peach: "æ­£è¥¿", wenchang: "æ­£è¥¿" },
            { name: "é¸¡", element: "é‡‘", clash: "æ­£ä¸œ (å¯)", friendly: "è›‡ã€ç‰›", noble: "ä¸œå—ã€ä¸œåŒ—", peach: "æ­£å—", wenchang: "æ­£åŒ—" },
            { name: "ç‹—", element: "åœŸ", clash: "ä¸œå— (è¾°)", friendly: "è™ã€é©¬", noble: "æ­£ä¸œã€æ­£å—", peach: "æ­£ä¸œ", wenchang: "æ­£åŒ—" },
            { name: "çŒª", element: "æ°´", clash: "ä¸œå— (å·³)", friendly: "å…”ã€ç¾Š", noble: "æ­£ä¸œã€æ­£å—", peach: "æ­£åŒ—", wenchang: "æ­£åŒ—" }
        ];

        // --- Logic Functions ---

        function getStarData(chart, palaceIndex) {
            // chart is array of 27. palaceIndex 0-8.
            const start = palaceIndex * 3;
            return {
                m: chart[start],
                f: chart[start+1],
                b: chart[start+2]
            };
        }

        function analyzePalace(starData, palaceName) {
            const { m, f, b } = starData;
            let verdict = "";
            let details = [];
            let score = 0; // Simple scoring for color coding

            // Period 9 Logic (9 is King, 1 is Future, 2 is distant future but illness, 8 is retreated)
            
            // 1. Facing Star (Wealth)
            if (f === 9) { verdict += "ã€è´¢æ˜Ÿå½“ä»¤ã€‘"; details.push("ä¹ç´«å‘æ˜Ÿé£ä¸´ï¼Œè´¢è¿æœ€æ—ºä¹‹æ–¹ã€‚å®œå¼€é—¨ã€è§æ°´ã€æ´»åŠ¨ã€‚"); score += 2; }
            else if (f === 1) { verdict += "ã€è¿‘æ—ºè´¢ä½ã€‘"; details.push("ä¸€ç™½å‘æ˜Ÿï¼Œä¸»æœªæ¥è´¢æ°”ï¼Œåˆ©åè´¢ã€äººç¼˜ã€‚"); score += 1; }
            else if (f === 2) { verdict += "ã€ç—…ç¬¦è´¢ã€‘"; details.push("äºŒé»‘è™½ä¸ºè¿œæ—ºï¼Œä½†æœ¬æ€§ä¸»ç—…ï¼Œæ±‚è´¢éœ€é˜²ç–¾ã€‚"); score -= 1; }
            else if (f === 5) { verdict += "ã€äº”é»„å¤§ç…ã€‘"; details.push("äº”é»„å‘æ˜Ÿï¼Œæ­¤æ—¶ä¸ºç…ï¼Œä¸å¯åŠ¨åœŸï¼Œä¸å¯è§æµåŠ¨ä¹‹æ°´ï¼ŒææŸè´¢ã€‚"); score -= 2; }
            else if (f === 7) { verdict += "ã€ç ´å†›é€€è´¢ã€‘"; details.push("ä¸ƒèµ¤é€€æ°”ï¼Œé˜²ç›—è´¼ã€å£èˆŒã€ç ´è€—ã€‚"); score -= 1; }

            // 2. Mountain Star (Health/People)
            if (m === 9) { verdict += "ã€æ—ºä¸ä¹‹ä½ã€‘"; details.push("ä¹ç´«å±±æ˜Ÿï¼Œä¸»å®¶äººå¥åº·ã€è´µäººæ‰¶æŒã€‚å®œå®‰åºŠã€ç½®æŸœã€‚"); score += 1; }
            else if (m === 1) { verdict += "ã€æ–‡æ˜Œäººä¸ã€‘"; details.push("ä¸€ç™½å±±æ˜Ÿï¼Œåˆ©å®¶ä¸­å°‘ç”·ï¼Œäº¦ä¸»æ™ºæ…§ã€‚"); score += 1; }
            else if (m === 5) { verdict += "ã€äº”é»„å…³ç…ã€‘"; details.push("äº”é»„å±±æ˜Ÿï¼Œä¸»èº«ä½“éšæ‚£ã€‚æ­¤æ–¹å®œé™ä¸å®œåŠ¨ï¼Œå¿Œçº¢è‰²å †æ”¾ã€‚"); score -= 2; }
            else if (m === 2) { verdict += "ã€ç—…ç¬¦å±±ã€‘"; details.push("äºŒé»‘å±±æ˜Ÿï¼Œä¸»æ…¢æ€§ç—…ï¼Œè€æ¯å—æŸã€‚"); score -= 1; }

            // 3. Special Combinations
            if (m === 9 && f === 9) {
                verdict = "â˜… åŒæ˜Ÿä¼šèš â˜… " + verdict;
                details.push("ä¹ä¹åŒå®«ï¼Œè‹¥å¤–å±€å±±æ°´é…åˆå¾—å®œï¼Œåˆ™ä¸è´¢ä¸¤æ—ºï¼Œä¸ºå…¨å±‹æœ€å‰ä¹‹ä½ï¼");
                score += 3;
            }
            if (m === 2 && f === 5) {
                verdict = "!!! äºŒäº”äº¤åŠ  !!!";
                details.push("äºŒäº”äº¤åŠ å¿…æŸä¸»ï¼Œæ­¤ä¹ƒå…¨å±‹æœ€å‡¶ä¹‹ä½ï¼Œå¿…é¡»æŒ‚é“œé“ƒåŒ–è§£ï¼Œåˆ‡å¿Œåå§ã€‚");
                score -= 5;
            }
            if (m === 5 && f === 2) {
                verdict = "!!! äºŒäº”äº¤åŠ  !!!";
                details.push("äºŒäº”äº¤åŠ ï¼Œç¾ç—…é‡é‡ã€‚");
                score -= 5;
            }
            if ((m === 1 && f === 4) || (m === 4 && f === 1)) {
                verdict += "ã€æ–‡æ˜Œä½ã€‘";
                details.push("ä¸€å››åŒå®«ï¼Œå‡†å‘ç§‘åã€‚æœ€åˆ©è¯»ä¹¦ã€è€ƒè¯•ã€æ–‡èŒå·¥ä½œã€‚");
                score += 1;
            }
            if (m === 3 && f === 7) {
                details.push("ä¸‰ä¸ƒå ä¸´ï¼Œç©¿å¿ƒç…ï¼Œé˜²è¢«ç›—ã€å››è‚¢å—ä¼¤ã€‚");
                score -= 1;
            }
            
            // Refine score string
            let scoreClass = "text-stone-600";
            if (score >= 2) scoreClass = "text-red-700 font-bold";
            if (score <= -2) scoreClass = "text-stone-900 font-bold"; // Bad luck in dark

            return { verdict, details, scoreClass };
        }

        // --- App Component ---

        function App() {
            const [step, setStep] = useState(1);
            const [formData, setFormData] = useState({
                name: "",
                familyZodiacs: [],
                address: "",
                buildYear: "",
                orientation: "", // Name like "å­å±±åˆå‘"
                notes: "",
                imageUrl: null
            });

            // Init Icons
            useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons();
                }
            });

            const handleAnalyze = () => {
                if (!formData.name || !formData.orientation || !formData.imageUrl) {
                    alert("å®¢å®˜ï¼Œå¤©æœºä¸å¯ç¼ºã€‚è¯·è¡¥å…¨å§“åã€åå‘åŠæˆ·å‹å›¾ã€‚");
                    return;
                }
                setStep(2);
            };

            const reset = () => setStep(1);

            return (
                <div className="min-h-screen flex flex-col">
                    <header className="ink-bg text-white p-4 shadow-md no-print">
                        <div className="container mx-auto flex justify-between items-center">
                            <div className="flex items-center gap-2">
                                <i data-lucide="compass" className="w-6 h-6 text-stone-300"></i>
                                <span className="text-xl font-bold serif tracking-wider">ä¸‰åŒäº‹é»‘æ‰‡å­</span>
                            </div>
                            <nav className="text-xs md:text-sm space-x-4 text-slate-400">
                                <span className="text-white">ä¸‰å…ƒç„ç©º Â· ä¹è¿çœŸè§£</span>
                            </nav>
                        </div>
                    </header>

                    <main className="flex-grow container mx-auto p-2 md:p-6">
                        {step === 1 ? (
                            <InputForm 
                                formData={formData} 
                                setFormData={setFormData} 
                                onAnalyze={handleAnalyze} 
                            />
                        ) : (
                            <AnalysisReport 
                                formData={formData} 
                                onBack={reset}
                            />
                        )}
                    </main>

                    <footer className="bg-stone-200 py-4 text-center text-stone-500 text-xs no-print">
                        <p>Â© 2025 ä¸‰åŒäº‹é»‘æ‰‡å­ | ä¸“ä¸šé£æ°´å·¥å…·</p>
                    </footer>
                </div>
            );
        }

        function InputForm({ formData, setFormData, onAnalyze }) {
            const fileInputRef = useRef(null);

            // Re-run icons when component mounts
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, []);

            const handleInputChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const toggleZodiac = (zodiacName) => {
                setFormData(prev => {
                    const current = prev.familyZodiacs;
                    return current.includes(zodiacName) 
                        ? { ...prev, familyZodiacs: current.filter(z => z !== zodiacName) }
                        : { ...prev, familyZodiacs: [...current, zodiacName] };
                });
            };

            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const url = URL.createObjectURL(file);
                    setFormData(prev => ({ ...prev, imageUrl: url }));
                }
            };

            return (
                <div className="max-w-4xl mx-auto bg-white p-6 md:p-10 rounded shadow-sm border border-stone-200">
                    <h2 className="text-2xl font-bold mb-8 text-center serif ink-text border-b-2 border-slate-900 pb-3">é£æ°´å‹˜éªŒ Â· ç¼˜èµ·ç™»è®°</h2>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div className="space-y-5">
                            <div>
                                <label className="form-label font-bold text-sm text-stone-600 block mb-1">æˆ·ä¸»é›…å·/å§“å</label>
                                <input type="text" name="name" value={formData.name} onChange={handleInputChange} className="w-full bg-stone-50 border border-stone-300 p-2 rounded focus:outline-none focus:border-slate-800 transition" placeholder="è¯·å¡«å†™" />
                            </div>
                            <div>
                                <label className="form-label font-bold text-sm text-stone-600 block mb-1">å ªèˆ†åœ°å€</label>
                                <input type="text" name="address" value={formData.address} onChange={handleInputChange} className="w-full bg-stone-50 border border-stone-300 p-2 rounded" placeholder="çœ / å¸‚ / åŒº" />
                            </div>
                            <div>
                                <label className="form-label font-bold text-sm text-stone-600 block mb-1">æˆ¿å±‹å»ºæˆ/å…¥ä¼™å¹´ä»½</label>
                                <input type="number" name="buildYear" value={formData.buildYear} onChange={handleInputChange} className="w-full bg-stone-50 border border-stone-300 p-2 rounded" placeholder="å¦‚ï¼š2023" />
                            </div>
                            <div>
                                <label className="form-label font-bold text-sm text-stone-600 block mb-1">ç²¾å‡†åå‘ (åŠ¡å¿…å®æµ‹)</label>
                                <select name="orientation" value={formData.orientation} onChange={handleInputChange} className="w-full bg-stone-50 border border-stone-300 p-2 rounded cursor-pointer">
                                    <option value="">-- è¯·é€‰æ‹©ç½—ç›˜åå‘ --</option>
                                    {MOUNTAINS_24.map((m, i) => (
                                        <option key={i} value={m.name}>{m.name}</option>
                                    ))}
                                </select>
                            </div>
                            <div>
                                <label className="form-label font-bold text-sm text-stone-600 block mb-2">å®¶åº­æˆå‘˜å±ç›¸</label>
                                <div className="grid grid-cols-6 gap-2">
                                    {ZODIACS.map((z) => (
                                        <button key={z.name} onClick={() => toggleZodiac(z.name)} className={`text-xs p-2 rounded border transition ${formData.familyZodiacs.includes(z.name) ? 'bg-slate-800 text-white border-slate-800' : 'bg-white text-stone-500 border-stone-200 hover:border-slate-400'}`}>
                                            {z.name}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>

                        <div className="space-y-5">
                            <div>
                                <label className="form-label font-bold text-sm text-stone-600 block mb-1">ä¸Šä¼ æˆ·å‹å›¾ (è¯·åŠ¡å¿…æ ‡æ˜åŒ—å‘)</label>
                                <div onClick={() => fileInputRef.current.click()} className="h-56 border-2 border-dashed border-stone-300 rounded bg-stone-50 flex flex-col items-center justify-center cursor-pointer hover:bg-stone-100 transition relative overflow-hidden">
                                    {formData.imageUrl ? (
                                        <img src={formData.imageUrl} className="w-full h-full object-contain" alt="preview" />
                                    ) : (
                                        <>
                                            <i data-lucide="upload-cloud" className="w-8 h-8 text-stone-400 mb-2"></i>
                                            <span className="text-xs text-stone-500">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡ (JPG/PNG)</span>
                                        </>
                                    )}
                                </div>
                                <input type="file" ref={fileInputRef} onChange={handleImageUpload} className="hidden" accept="image/*" />
                            </div>
                            <div>
                                <label className="form-label font-bold text-sm text-stone-600 block mb-1">ç‰¹åˆ«è¯‰æ±‚ / é—®é¢˜æè¿°</label>
                                <textarea name="notes" value={formData.notes} onChange={handleInputChange} className="w-full bg-stone-50 border border-stone-300 p-2 rounded h-32 resize-none text-sm" placeholder="å¦‚ï¼šæƒ³å‚¬æ—ºè´¢è¿ï¼Œå®¶ä¸­è€äººèº«ä½“ä¸é€‚..."></textarea>
                            </div>
                        </div>
                    </div>

                    <div className="mt-10 flex justify-center">
                        <button onClick={onAnalyze} className="bg-slate-900 text-white px-12 py-3 rounded hover:bg-slate-800 transition shadow-lg text-lg serif tracking-widest flex items-center gap-2">
                            <span>æ’ç›˜æ¼”å¦</span>
                        </button>
                    </div>
                </div>
            );
        }

        function AnalysisReport({ formData, onBack }) {
            const [activeCell, setActiveCell] = useState(null);
            const [isGeneratingPdf, setIsGeneratingPdf] = useState(false);
            const reportRef = useRef(null);

            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, []);

            // 1. Get Chart Data
            const selectedChart = MOUNTAINS_24.find(m => m.name === formData.orientation);
            // Default to North-South if something wrong, but validation prevents this
            const chartData = selectedChart ? selectedChart.period9Chart : MOUNTAINS_24[1].period9Chart;

            // 2. Map Data to 9 Palaces
            const processedPalaces = PALACES.map((p, index) => {
                const stars = getStarData(chartData, index);
                const analysis = analyzePalace(stars, p.name);
                return { ...p, stars, analysis };
            });

            // 3. Process Zodiacs
            const zodiacInsights = formData.familyZodiacs.map(z => {
                const data = ZODIACS.find(item => item.name === z);
                return { ...data, userZodiac: z };
            });

            // 4. Handle PDF Generation - SAFE METHOD
            const generatePDF = async () => {
                if (isGeneratingPdf) return;
                
                // CRITICAL SAFETY CHECK for jsPDF
                if (!window.jspdf || !window.jspdf.jsPDF) {
                    alert("PDFç»„ä»¶å°šæœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åé‡è¯•æˆ–åˆ·æ–°é¡µé¢ã€‚");
                    return;
                }

                setIsGeneratingPdf(true);
                
                try {
                    const { jsPDF } = window.jspdf;
                    const element = reportRef.current;
                    const canvas = await html2canvas(element, {
                        scale: 2, // High resolution
                        useCORS: true,
                        logging: false
                    });
                    
                    const imgData = canvas.toDataURL('image/jpeg', 1.0);
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    const imgWidth = canvas.width;
                    const imgHeight = canvas.height;
                    const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight);
                    
                    // Simple fit to width
                    const finalImgHeight = imgHeight * (pdfWidth / imgWidth);
                    
                    // Add image to PDF
                    pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, finalImgHeight);
                    pdf.save(`ä¸‰åŒäº‹é»‘æ‰‡å­é£æ°´æŠ¥å‘Š_${formData.name}.pdf`);
                } catch (err) {
                    console.error("PDF Gen Error:", err);
                    alert("ç”ŸæˆPDFå¤±è´¥ï¼Œå»ºè®®ç›´æ¥ä½¿ç”¨æµè§ˆå™¨æ‰“å°åŠŸèƒ½ï¼ˆæŒ‰Ctrl+Pï¼‰ã€‚");
                } finally {
                    setIsGeneratingPdf(false);
                }
            };

            return (
                <div className="flex flex-col gap-6">
                    {/* Toolbar */}
                    <div className="flex justify-between items-center no-print px-2">
                        <button onClick={onBack} className="text-stone-500 hover:text-slate-900 flex items-center gap-1 text-sm">
                            <i data-lucide="arrow-left" className="w-4 h-4"></i> è¿”å›é‡å¡«
                        </button>
                        <button 
                            onClick={generatePDF} 
                            disabled={isGeneratingPdf}
                            className={`bg-slate-900 text-white px-5 py-2 rounded text-sm hover:bg-slate-800 flex items-center gap-2 ${isGeneratingPdf ? 'opacity-70 cursor-wait' : ''}`}
                        >
                            {isGeneratingPdf ? <div className="loader w-4 h-4 border-2"></div> : <i data-lucide="file-down" className="w-4 h-4"></i>}
                            {isGeneratingPdf ? "ç”Ÿæˆä¸­..." : "ä¸‹è½½ä¸“ä¸šPDFæŠ¥å‘Š"}
                        </button>
                    </div>

                    {/* Report Content (Target for PDF) */}
                    <div ref={reportRef} className="bg-white p-8 md:p-12 shadow-2xl max-w-5xl mx-auto w-full text-stone-900">
                        
                        {/* 1. Header */}
                        <div className="text-center border-b-4 border-slate-900 pb-6 mb-8">
                            <h1 className="text-4xl font-bold serif text-slate-900 mb-2 tracking-widest">ä¸‰åŒäº‹é»‘æ‰‡å­</h1>
                            <div className="flex justify-center items-center gap-4 text-sm tracking-widest text-stone-500 uppercase mt-2">
                                <span>San Yuan Xuan Kong</span>
                                <span>â€¢</span>
                                <span>Period 9 Feng Shui</span>
                            </div>
                        </div>

                        {/* 2. Info Block */}
                        <div className="bg-stone-50 border border-stone-200 p-6 mb-8 grid grid-cols-2 md:grid-cols-4 gap-6 text-sm">
                            <div><span className="block text-xs text-stone-400 uppercase">æˆ·ä¸»</span><span className="font-bold text-lg">{formData.name}</span></div>
                            <div><span className="block text-xs text-stone-400 uppercase">åå‘</span><span className="font-bold text-lg text-indigo-900">{formData.orientation}</span></div>
                            <div><span className="block text-xs text-stone-400 uppercase">å»ºæˆ</span><span className="font-bold text-lg">{formData.buildYear}</span></div>
                            <div><span className="block text-xs text-stone-400 uppercase">æ—¶è¿</span><span className="font-bold text-lg text-red-700">ä¹è¿ (ç¦»ç«)</span></div>
                            <div className="col-span-2 md:col-span-4 border-t border-stone-200 pt-3">
                                <span className="block text-xs text-stone-400 uppercase mb-1">ç‰¹åˆ«è¯´æ˜</span>
                                <p className="italic text-stone-600">{formData.notes || "æ— "}</p>
                            </div>
                        </div>

                        {/* 3. Main Chart & Grid */}
                        <div className="flex flex-col md:flex-row gap-8 mb-12">
                            {/* Left: Visual Map */}
                            <div className="w-full md:w-1/2 relative">
                                <h3 className="text-lg font-bold mb-3 flex items-center gap-2">
                                    <span className="bg-slate-900 text-white px-2 py-0.5 text-xs rounded">å›¾è§£</span>
                                    ä¹å®«é£æ˜Ÿæ’ç›˜
                                </h3>
                                <div className="relative aspect-square border-2 border-slate-900 bg-stone-100 overflow-hidden">
                                    <img src={formData.imageUrl} className="w-full h-full object-contain opacity-40 grayscale" alt="Floor Plan" />
                                    
                                    <div className="grid-overlay">
                                        <GridCell palace={processedPalaces[0]} pos="1 / 1 / 2 / 2" onActive={setActiveCell} /> {/* NW */}
                                        <GridCell palace={processedPalaces[1]} pos="1 / 2 / 2 / 3" onActive={setActiveCell} /> {/* N */}
                                        <GridCell palace={processedPalaces[2]} pos="1 / 3 / 2 / 4" onActive={setActiveCell} /> {/* NE */}
                                        
                                        <GridCell palace={processedPalaces[3]} pos="2 / 1 / 2 / 2" onActive={setActiveCell} /> {/* W */}
                                        <GridCell palace={processedPalaces[4]} pos="2 / 2 / 3 / 3" onActive={setActiveCell} /> {/* C */}
                                        <GridCell palace={processedPalaces[5]} pos="2 / 3 / 3 / 4" onActive={setActiveCell} /> {/* E */}
                                        
                                        <GridCell palace={processedPalaces[6]} pos="3 / 1 / 4 / 2" onActive={setActiveCell} /> {/* SW */}
                                        <GridCell palace={processedPalaces[7]} pos="3 / 2 / 4 / 3" onActive={setActiveCell} /> {/* S */}
                                        <GridCell palace={processedPalaces[8]} pos="3 / 3 / 4 / 4" onActive={setActiveCell} /> {/* SE */}
                                    </div>
                                </div>
                                <div className="text-xs text-center mt-2 text-stone-400">
                                    * é»˜è®¤åœ°å›¾æ–¹ä½ï¼šä¸ŠåŒ—ä¸‹å— * <br/>
                                    <span className="text-blue-700 font-bold">å·¦ä¸Š:å±±æ˜Ÿ</span> | <span className="text-red-700 font-bold">å³ä¸Š:å‘æ˜Ÿ</span> | <span className="text-stone-800 font-bold">ä¸­é—´:è¿æ˜Ÿ</span>
                                </div>
                            </div>

                            {/* Right: Analysis Detail */}
                            <div className="w-full md:w-1/2 flex flex-col">
                                <h3 className="text-lg font-bold mb-3 flex items-center gap-2">
                                    <span className="bg-red-800 text-white px-2 py-0.5 text-xs rounded">è®ºæ–­</span>
                                    æ–¹ä½å‰å‡¶è¯¦è§£
                                </h3>
                                <div className="flex-grow bg-stone-50 border border-stone-300 p-5 rounded-sm h-full min-h-[300px]">
                                    {activeCell ? (
                                        <div className="animate-fade-in">
                                            <div className="flex justify-between items-baseline border-b border-stone-300 pb-2 mb-3">
                                                <h4 className="text-xl font-bold serif text-slate-900">{activeCell.name}</h4>
                                                <div className="text-xs font-mono text-stone-500">
                                                    å±±{activeCell.stars.m} - å‘{activeCell.stars.f} - è¿{activeCell.stars.b}
                                                </div>
                                            </div>
                                            <div className="space-y-4">
                                                <div>
                                                    <span className="text-xs font-bold text-stone-400 uppercase tracking-wider">å‰å‡¶å®šæ€§</span>
                                                    <p className={`text-lg serif mt-1 ${activeCell.analysis.scoreClass}`}>{activeCell.analysis.verdict || "å¹³"}</p>
                                                </div>
                                                <div>
                                                    <span className="text-xs font-bold text-stone-400 uppercase tracking-wider">é»‘æ‰‡å­æ‰¹æ³¨</span>
                                                    <ul className="mt-2 space-y-2">
                                                        {activeCell.analysis.details.map((detail, idx) => (
                                                            <li key={idx} className="text-sm text-stone-700 leading-relaxed flex gap-2">
                                                                <span className="text-slate-400">â¤</span>
                                                                {detail}
                                                            </li>
                                                        ))}
                                                        {activeCell.analysis.details.length === 0 && <li className="text-sm text-stone-500 italic">æ­¤æ–¹æ°”åœºå¹³ç¨³ï¼Œæ— æ˜æ˜¾å‰å‡¶å…‹åº”ï¼Œå¯ä½œå¸¸è§„ä½¿ç”¨ã€‚</li>}
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="h-full flex flex-col items-center justify-center text-stone-400 space-y-3">
                                            <i data-lucide="mouse-pointer-click" className="w-8 h-8 opacity-50"></i>
                                            <p className="text-sm">ç‚¹å‡»å·¦ä¾§ä¹å®«æ ¼ä»»æ„åŒºåŸŸ<br/>æŸ¥çœ‹è¯¦ç»†é£æ°´è®ºæ–­</p>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>

                        {/* 4. Zodiac Matrix */}
                        <div className="mb-12">
                            <h3 className="text-lg font-bold border-l-4 border-slate-900 pl-3 mb-4">å‘½ç†ä¸æ–¹ä½æ·±åº¦å…³è”</h3>
                            {zodiacInsights.length > 0 ? (
                                <div className="grid grid-cols-1 gap-4">
                                    {zodiacInsights.map((z, idx) => (
                                        <div key={idx} className="bg-white border border-stone-200 p-4 shadow-sm flex flex-col md:flex-row md:items-center gap-4">
                                            <div className="md:w-1/6 flex flex-col items-center justify-center border-r border-stone-100 pr-4">
                                                <div className="w-12 h-12 bg-slate-900 text-white rounded-full flex items-center justify-center text-xl font-serif font-bold mb-1">
                                                    {z.userZodiac}
                                                </div>
                                                <span className="text-xs text-stone-500">äº”è¡Œå±{z.element}</span>
                                            </div>
                                            <div className="md:w-5/6 grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                                <div className="bg-red-50 p-2 rounded">
                                                    <span className="block text-xs text-red-400 font-bold mb-1">âš ï¸ å¿Œå†² (å…­å†²æ–¹)</span>
                                                    <span className="text-stone-800 font-medium">{z.clash}</span>
                                                </div>
                                                <div className="bg-blue-50 p-2 rounded">
                                                    <span className="block text-xs text-blue-400 font-bold mb-1">âœ¨ è´µäºº (å¤§å‰æ–¹)</span>
                                                    <span className="text-stone-800 font-medium">{z.noble}</span>
                                                </div>
                                                <div className="bg-pink-50 p-2 rounded">
                                                    <span className="block text-xs text-pink-400 font-bold mb-1">ğŸŒ¸ æ¡ƒèŠ± (äººç¼˜æ–¹)</span>
                                                    <span className="text-stone-800 font-medium">{z.peach}</span>
                                                </div>
                                                <div className="bg-emerald-50 p-2 rounded">
                                                    <span className="block text-xs text-emerald-600 font-bold mb-1">ğŸ“š æ–‡æ˜Œ (å­¦ä¸šæ–¹)</span>
                                                    <span className="text-stone-800 font-medium">{z.wenchang}</span>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <p className="text-stone-500 text-sm italic p-4 bg-stone-50">æœªå½•å…¥å±ç›¸ä¿¡æ¯ï¼Œæ— æ³•è¿›è¡Œå‘½ç†æ–¹ä½åŒ¹é…ã€‚</p>
                            )}
                        </div>

                        {/* 5. Footer */}
                        <div className="text-center pt-8 border-t border-stone-200">
                            <p className="font-serif font-bold text-xl text-slate-900 mb-2">â€œå¤©æœºå·²éœ²ï¼Œå‰å‡¶è‡ªæ‹…â€</p>
                            <p className="text-xs text-stone-400">æŠ¥å‘Šç”Ÿæˆæ—¶é—´ï¼š{new Date().toLocaleDateString()} | ä¸‰åŒäº‹é»‘æ‰‡å­ç³»ç»Ÿè‡ªåŠ¨æ¼”ç®—</p>
                        </div>
                    </div>
                </div>
            );
        }

        // Grid Cell Component
        function GridCell({ palace, pos, onActive }) {
            const { stars } = palace;
            // Determine background opacity based on potential "evil" stars to visualize hotspots slightly
            // 5 is worst.
            const isDanger = stars.m === 5 || stars.f === 5 || (stars.m === 2 && stars.f === 5);
            const isGood = stars.f === 9 || stars.f === 1 || (stars.m === 9 && stars.f === 9);

            let bgStyle = {};
            if (isDanger) bgStyle = { backgroundColor: 'rgba(254, 202, 202, 0.2)' }; // faint red
            if (isGood) bgStyle = { backgroundColor: 'rgba(209, 250, 229, 0.2)' }; // faint green

            return (
                <div 
                    className="grid-cell" 
                    style={{ gridArea: pos, ...bgStyle }}
                    onClick={() => onActive(palace)}
                >
                    <div className="star-layout">
                        <div className="star-sitting">{stars.m}</div>
                        <div className="star-facing">{stars.f}</div>
                        <div className="star-base">{stars.b}</div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
