<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>黑扇子八字排盘</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 引入中文字体 -->
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Serif+SC:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* 自定义字体与纹理 */
        :root {
            --color-cinnabar: #C41E3A; /* 朱红 */
            --color-indigo: #0F4C81;   /* 黛青 */
            --color-beige: #F5F0E6;    /* 米白 */
            --color-gold: #D4AF37;     /* 金箔 */
            --font-title: 'Ma Shan Zheng', cursive; /* 隶书风格 */
            --font-body: 'Noto Serif SC', serif;    /* 宋体风格 */
        }

        body {
            background-color: var(--color-beige);
            font-family: var(--font-body);
            color: #333;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23d4af37' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        .font-lishu { font-family: var(--font-title); }
        .text-cinnabar { color: var(--color-cinnabar); }
        .text-indigo { color: var(--color-indigo); }
        .text-gold { color: var(--color-gold); }
        .bg-cinnabar { background-color: var(--color-cinnabar); }
        .bg-indigo { background-color: var(--color-indigo); }
        .border-gold { border-color: var(--color-gold); }

        /* 仿古边框 */
        .vintage-border {
            border: 2px solid var(--color-gold);
            outline: 1px solid var(--color-indigo);
            outline-offset: -4px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .cloud-pattern {
            background-image: radial-gradient(circle at 100% 100%, transparent 10px, var(--color-gold) 11px, var(--color-gold) 12px, transparent 13px),
                              radial-gradient(circle at 0 100%, transparent 10px, var(--color-gold) 11px, var(--color-gold) 12px, transparent 13px);
            background-size: 20px 20px;
            background-position: bottom;
            background-repeat: repeat-x;
        }
        
        /* 竖排文字 */
        .vertical-text {
            writing-mode: vertical-rl;
            text-orientation: upright;
            letter-spacing: 2px;
        }

        /* 模拟印章 */
        .seal {
            border: 2px solid var(--color-cinnabar);
            color: var(--color-cinnabar);
            border-radius: 4px;
            padding: 2px 4px;
            font-family: var(--font-title);
            transform: rotate(-5deg);
            display: inline-block;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- 核心常量与数据库 ---
        const GAN = ["甲", "乙", "丙", "丁", "戊", "己", "庚", "辛", "壬", "癸"];
        const ZHI = ["子", "丑", "寅", "卯", "辰", "巳", "午", "未", "申", "酉", "戌", "亥"];
        const ZHI_HIDDEN = {
            "子": [{gan:"癸", type:"本气"}],
            "丑": [{gan:"己", type:"本气"}, {gan:"癸", type:"余气"}, {gan:"辛", type:"藏干"}],
            "寅": [{gan:"甲", type:"本气"}, {gan:"丙", type:"余气"}, {gan:"戊", type:"藏干"}],
            "卯": [{gan:"乙", type:"本气"}],
            "辰": [{gan:"戊", type:"本气"}, {gan:"乙", type:"余气"}, {gan:"癸", type:"藏干"}],
            "巳": [{gan:"丙", type:"本气"}, {gan:"戊", type:"余气"}, {gan:"庚", type:"藏干"}],
            "午": [{gan:"丁", type:"本气"}, {gan:"己", type:"藏干"}],
            "未": [{gan:"己", type:"本气"}, {gan:"丁", type:"余气"}, {gan:"乙", type:"藏干"}],
            "申": [{gan:"庚", type:"本气"}, {gan:"壬", type:"余气"}, {gan:"戊", type:"藏干"}],
            "酉": [{gan:"辛", type:"本气"}],
            "戌": [{gan:"戊", type:"本气"}, {gan:"辛", type:"余气"}, {gan:"丁", type:"藏干"}],
            "亥": [{gan:"壬", type:"本气"}, {gan:"甲", type:"藏干"}]
        };

        const NA_YIN = {
            "甲子": "海中金", "乙丑": "海中金", "丙寅": "炉中火", "丁卯": "炉中火", "戊辰": "大林木", "己巳": "大林木",
            "庚午": "路旁土", "辛未": "路旁土", "壬申": "剑锋金", "癸酉": "剑锋金", "甲戌": "山头火", "乙亥": "山头火",
            "丙子": "涧下水", "丁丑": "涧下水", "戊寅": "城头土", "己卯": "城头土", "庚辰": "白蜡金", "辛巳": "白蜡金",
            "壬午": "杨柳木", "癸未": "杨柳木", "甲申": "泉中水", "乙酉": "泉中水", "丙戌": "屋上土", "丁亥": "屋上土",
            "戊子": "霹雳火", "己丑": "霹雳火", "庚寅": "松柏木", "辛卯": "松柏木", "壬辰": "长流水", "癸巳": "长流水",
            "甲午": "沙中金", "乙未": "沙中金", "丙申": "山下火", "丁酉": "山下火", "戊戌": "平地木", "己亥": "平地木",
            "庚子": "壁上土", "辛丑": "壁上土", "壬寅": "金箔金", "癸卯": "金箔金", "甲辰": "覆灯火", "乙巳": "覆灯火",
            "丙午": "天河水", "丁未": "天河水", "戊申": "大驿土", "己酉": "大驿土", "庚戌": "钗钏金", "辛亥": "钗钏金",
            "壬子": "桑柘木", "癸丑": "桑柘木", "甲寅": "大溪水", "乙卯": "大溪水", "丙辰": "沙中土", "丁巳": "沙中土",
            "戊午": "天上火", "己未": "天上火", "庚申": "石榴木", "辛酉": "石榴木", "壬戌": "大海水", "癸亥": "大海水"
        };

        const BAGUA_NAMES = ["", "乾", "兑", "离", "震", "巽", "坎", "艮", "坤"]; // 1-8 对应先天数 (需注意取余处理)
        const BAGUA_ATTR = {
            "乾": { five: "金", desc: "天行健，君子以自强不息", lucky: ["土", "金"], type: "吉" },
            "兑": { five: "金", desc: "丽泽，兑；君子以朋友讲习", lucky: ["土", "金"], type: "吉" },
            "离": { five: "火", desc: "明两作，离；大人以继明照于四方", lucky: ["木", "火"], type: "吉" },
            "震": { five: "木", desc: "震惊百里，不丧匙鬯", lucky: ["水", "木"], type: "吉" },
            "巽": { five: "木", desc: "随风，巽；君子以申命行事", lucky: ["水", "木"], type: "吉" },
            "坎": { five: "水", desc: "水洊至，习坎；君子以常德行，习教事", lucky: ["金", "水"], type: "凶" },
            "艮": { five: "土", desc: "兼山，艮；君子以思不出其位", lucky: ["火", "土"], type: "中平" },
            "坤": { five: "土", desc: "地势坤，君子以厚德载物", lucky: ["火", "土"], type: "吉" }
        };

        // --- 核心算法函数 ---

        // 新增：获取天干五行
        const getFiveElement = (gan) => {
            const idx = GAN.indexOf(gan);
            if (idx <= 1) return "木";
            if (idx <= 3) return "火";
            if (idx <= 5) return "土";
            if (idx <= 7) return "金";
            return "水";
        };

        // 新增：模拟康熙笔画计算 (解决姓名卦象不变的问题)
        // 注意：真实生产环境应连接后端康熙字典数据库，此处为单文件演示，使用"常用字库+Hash算法"确保不同名字结果不同
        const getSimulatedStrokes = (name) => {
            if (!name) return 0;
            // 常用姓氏康熙笔画 (示例)
            const commonDict = {
                "张": 11, "李": 7, "王": 4, "赵": 14, "刘": 15, "陈": 16, "杨": 13, "黄": 12, "周": 8, "吴": 7,
                "三": 3, "四": 5, "五": 5, "六": 4, "七": 2, "八": 2, "九": 2, "十": 2, 
                "天": 4, "地": 6, "人": 2, "伟": 11, "芳": 10, "娜": 10, "强": 11
            };
            
            let total = 0;
            for (let char of name) {
                if (commonDict[char]) {
                    total += commonDict[char];
                } else {
                    // 对于未在微型字典中的字，使用字符编码生成一个固定的数(1-20之间)，确保同一个字每次计算结果一致，不同字结果不同
                    total += (char.charCodeAt(0) % 20) + 1;
                }
            }
            return total;
        };

        // 1. 十神推导 (日主 vs 他干)
        const getTenGod = (dayGan, targetGan) => {
            if (!targetGan) return "";
            const dayIdx = GAN.indexOf(dayGan);
            const targetIdx = GAN.indexOf(targetGan);
            
            // 五行属性: 甲乙木(0,1) 丙丁火(2,3) 戊己土(4,5) 庚辛金(6,7) 壬癸水(8,9)
            const dayEl = Math.floor(dayIdx / 2);
            const targetEl = Math.floor(targetIdx / 2);
            
            // 阴阳属性: 偶数阳，奇数阴
            const dayYinYang = dayIdx % 2;
            const targetYinYang = targetIdx % 2;
            const sameYinYang = dayYinYang === targetYinYang;

            // 生克关系
            if (dayEl === targetEl) return sameYinYang ? "比肩" : "劫财"; // 同我
            if ((dayEl + 1) % 5 === targetEl) return sameYinYang ? "食神" : "伤官"; // 我生
            if ((targetEl + 1) % 5 === dayEl) return sameYinYang ? "偏印" : "正印"; // 生我
            if ((dayEl + 2) % 5 === targetEl) return sameYinYang ? "偏财" : "正财"; // 我克
            if ((targetEl + 2) % 5 === dayEl) return sameYinYang ? "七杀" : "正官"; // 克我
            return "未知";
        };

        // 2. 空亡推导 (日柱查空亡)
        // 甲子旬空戌亥，甲戌旬空申酉...
        const getKongWang = (dayGan, dayZhi) => {
            const ganIdx = GAN.indexOf(dayGan);
            const zhiIdx = ZHI.indexOf(dayZhi);
            const diff = (zhiIdx - ganIdx + 12) % 12; // 寻找旬首
            // 旬首对应的空亡
            if (diff === 0) return ["戌", "亥"]; // 甲子旬
            if (diff === 10) return ["申", "酉"]; // 甲戌旬
            if (diff === 8) return ["午", "未"]; // 甲申旬
            if (diff === 6) return ["辰", "巳"]; // 甲午旬
            if (diff === 4) return ["寅", "卯"]; // 甲辰旬
            if (diff === 2) return ["子", "丑"]; // 甲寅旬
            return [];
        };

        // 3. 简化排盘逻辑 (由于无法引入巨大天文库，此处使用模拟算法，逻辑上符合规则)
        // 实际开发中需替换为 lunar-javascript 库
        const calculateBazi = (dateStr, timeHour, gender, isSolarTime) => {
            // 修正：直接解析 YYYY-MM-DD 字符串，避免 new Date(dateStr) 产生的 UTC/本地时区偏差导致日期错乱
            const [yStr, mStr, dStr] = dateStr.split('-');
            const year = parseInt(yStr);
            const month = parseInt(mStr);
            const day = parseInt(dStr);

            // 创建本地时间对象 (月份需减1，用于后续计算)
            const date = new Date(year, month - 1, day);

            // --- 模拟干支计算 (简化演示版) ---
            // 真实算法需要复杂的积日计算和节气精确时刻
            // 此处为了展示逻辑，采用近似推导
            
            // 1. 年柱 (基于立春，通常2月4日)
            const baseYear = 1900; // 庚子年
            let yearOffset = year - baseYear;
            if (month < 2 || (month === 2 && day < 4)) {
                yearOffset -= 1; // 立春前算上一年
            }
            const yearGanIdx = (6 + yearOffset) % 10; // 1900是庚(6)
            const yearZhiIdx = (0 + yearOffset) % 12; // 1900是子(0)
            
            const yearGan = GAN[(yearGanIdx + 10) % 10];
            const yearZhi = ZHI[(yearZhiIdx + 12) % 12];

            // 2. 月柱 (五虎遁: 甲己之年丙作首)
            // 简化节气月令：2月寅，3月卯...
            let monthZhiIdx = (month) % 12; 
            if (day < 6) monthZhiIdx = (monthZhiIdx - 1 + 12) % 12; // 简单节气修正
            const monthZhi = ZHI[monthZhiIdx];
            
            // 月干推导
            let monthGanStartIdx = 0;
            if (yearGan === '甲' || yearGan === '己') monthGanStartIdx = 2; // 丙寅
            if (yearGan === '乙' || yearGan === '庚') monthGanStartIdx = 4; // 戊寅
            if (yearGan === '丙' || yearGan === '辛') monthGanStartIdx = 6; // 庚寅
            if (yearGan === '丁' || yearGan === '壬') monthGanStartIdx = 8; // 壬寅
            if (yearGan === '戊' || yearGan === '癸') monthGanStartIdx = 0; // 甲寅
            
            // 月支 offset (寅是0号基准)
            const monthOffset = (ZHI.indexOf(monthZhi) - 2 + 12) % 12;
            const monthGan = GAN[(monthGanStartIdx + monthOffset) % 10];

            // 3. 日柱 (修正时区导致的日期偏差)
            // 基准日：1900年1月31日 (甲辰日)
            // 务必使用与输入日期相同的构造方式，确保时区一致
            const baseDate = new Date(1900, 0, 31); 
            
            // 计算毫秒差
            const diffTime = date.getTime() - baseDate.getTime();
            
            // 使用 Math.round 消除夏令时或跨时区导致的微小时间偏差 (如 0.99 天 -> 1 天)
            const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));
            
            // 计算干支索引 (处理负数情况，确保取模正确)
            const dayGanIdx = (0 + diffDays % 10 + 10) % 10;
            const dayZhiIdx = (4 + diffDays % 12 + 12) % 12; // 1900.1.31 是甲辰日，辰对应索引 4
            
            const dayGan = GAN[dayGanIdx];
            const dayZhi = ZHI[dayZhiIdx];

            // 4. 时柱 (五鼠遁: 甲己还加甲)
            // 获取时支
            let hourZhiIdx = 0;
            if (timeHour >= 23 || timeHour < 1) hourZhiIdx = 0; // 子
            else hourZhiIdx = Math.floor((timeHour + 1) / 2);
            
            const hourZhi = ZHI[hourZhiIdx];

            // 时干推导
            let hourGanStartIdx = 0;
            if (dayGan === '甲' || dayGan === '己') hourGanStartIdx = 0; // 甲子
            if (dayGan === '乙' || dayGan === '庚') hourGanStartIdx = 2; // 丙子
            if (dayGan === '丙' || dayGan === '辛') hourGanStartIdx = 4; // 戊子
            if (dayGan === '丁' || dayGan === '壬') hourGanStartIdx = 6; // 庚子
            if (dayGan === '戊' || dayGan === '癸') hourGanStartIdx = 8; // 壬子
            
            const hourGan = GAN[(hourGanStartIdx + hourZhiIdx) % 10];

            return {
                year: { gan: yearGan, zhi: yearZhi },
                month: { gan: monthGan, zhi: monthZhi },
                day: { gan: dayGan, zhi: dayZhi },
                hour: { gan: hourGan, zhi: hourZhi }
            };
        };

        // 4. 姓名易卦计算
        const calculateNameYi = (name, totalStrokes, dayEl) => {
            // 先天八卦数: 乾1 兑2 离3 震4 巽5 坎6 艮7 坤8
            // 算法: 总笔画除8取余得主卦，除6取余得动爻
            
            const upperNum = totalStrokes % 8 || 8;
            const lowerNum = (totalStrokes + 0) % 8 || 8; // 简单起卦法通常上下卦相同或根据姓氏/名字拆分，此处按总笔画演示
            const yaoNum = totalStrokes % 6 || 6;

            const mainGua = BAGUA_NAMES[upperNum];
            
            // 简单吉凶判断
            const attr = BAGUA_ATTR[mainGua];
            let luck = "平";
            if (attr.lucky.includes(dayEl)) luck = "大吉 (卦气生助日主)";
            else if (attr.five === dayEl) luck = "吉 (比和)";
            else luck = "中 (需观变爻)";

            return {
                gua: mainGua,
                yao: yaoNum,
                desc: attr.desc,
                luck: luck,
                five: attr.five
            };
        };

        // --- 组件 ---

        const InputSection = ({ onCalculate }) => {
            const [formData, setFormData] = React.useState({
                name: "张三",
                date: "1990-05-15",
                time: "10",
                gender: "male",
                solar: false
            });

            const handleSubmit = (e) => {
                e.preventDefault();
                onCalculate(formData);
            };

            return (
                <div className="bg-white/80 p-4 rounded-lg vintage-border mb-6">
                    <form onSubmit={handleSubmit} className="grid grid-cols-2 md:grid-cols-4 gap-4 items-end">
                        <div className="col-span-1">
                            <label className="block text-xs text-indigo-900 mb-1 font-bold">姓 名</label>
                            <input type="text" value={formData.name} onChange={e=>setFormData({...formData, name: e.target.value})} 
                                className="w-full bg-transparent border-b-2 border-indigo-200 focus:border-cinnabar outline-none py-1 font-lishu text-lg" />
                        </div>
                        <div>
                            <label className="block text-xs text-indigo-900 mb-1 font-bold">出生日期 (公历)</label>
                            <input type="date" value={formData.date} onChange={e=>setFormData({...formData, date: e.target.value})}
                                className="w-full bg-transparent border-b-2 border-indigo-200 outline-none py-1" />
                        </div>
                        <div>
                            <label className="block text-xs text-indigo-900 mb-1 font-bold">出生时辰 (24h)</label>
                            <select value={formData.time} onChange={e=>setFormData({...formData, time: e.target.value})}
                                className="w-full bg-transparent border-b-2 border-indigo-200 outline-none py-1">
                                {Array.from({length:24}).map((_,i) => (
                                    <option key={i} value={i}>{i}:00 - {i}:59</option>
                                ))}
                            </select>
                        </div>
                        <div className="flex gap-4">
                            <label className="flex items-center">
                                <input type="radio" name="gender" checked={formData.gender==='male'} onChange={()=>setFormData({...formData, gender:'male'})} className="mr-1 accent-indigo-900"/> 
                                <span className="font-lishu text-lg">乾造</span>
                            </label>
                            <label className="flex items-center">
                                <input type="radio" name="gender" checked={formData.gender==='female'} onChange={()=>setFormData({...formData, gender:'female'})} className="mr-1 accent-cinnabar"/> 
                                <span className="font-lishu text-lg text-cinnabar">坤造</span>
                            </label>
                        </div>
                        <button type="submit" className="col-span-2 md:col-span-4 bg-indigo-900 text-gold py-2 rounded shadow-md font-lishu text-xl hover:bg-indigo-800 transition">
                            立即排盘
                        </button>
                    </form>
                </div>
            );
        };

        const BaziChart = ({ data, userInfo }) => {
            if (!data) return null;

            const pillars = ['year', 'month', 'day', 'hour'];
            const titles = ['年柱', '月柱', '日柱', '时柱'];
            const dayMaster = data.day.gan; // 日主

            // 辅助样式类
            const cellClass = "border-r border-indigo-200 p-2 text-center relative min-h-[60px] flex flex-col items-center justify-center";
            const headClass = "bg-indigo-900/10 text-indigo-900 font-bold p-2 text-center border-r border-indigo-200 font-lishu";
            
            // 计算空亡
            const kongWang = getKongWang(data.day.gan, data.day.zhi);

            return (
                <div className="vintage-border bg-white/90 p-1 relative overflow-hidden">
                    {/* 水印 */}
                    <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 opacity-5 pointer-events-none">
                        <span className="font-lishu text-9xl text-black">黑扇子</span>
                    </div>

                    {/* 顶部信息 */}
                    <div className="flex justify-between items-center border-b-2 border-gold pb-2 mb-2 px-2">
                        <div className="flex gap-4 items-center">
                            <span className="seal border-indigo-900 text-indigo-900">排盘</span>
                            <span className="font-lishu text-2xl text-indigo-900">{userInfo.name}</span>
                            <span className="text-xs bg-indigo-100 text-indigo-800 px-2 py-0.5 rounded">
                                {userInfo.gender === 'male' ? '乾造' : '坤造'}
                            </span>
                        </div>
                        <div className="text-right text-xs text-gray-600">
                            <div>公历：{userInfo.date} {userInfo.time}时</div>
                        </div>
                    </div>

                    {/* 核心排盘表格 */}
                    <div className="grid grid-cols-6 border-2 border-indigo-900 text-sm">
                        {/* 表头 */}
                        <div className={headClass + " bg-indigo-900 text-gold"}>项目</div>
                        <div className={headClass}>日期</div>
                        {pillars.map((p, i) => (
                            <div key={p} className={headClass}>{titles[i]}</div>
                        ))}

                        {/* 主星 (十神 - 天干) */}
                        <div className={cellClass + " font-bold text-gray-500"}>主星</div>
                        <div className={cellClass}></div>
                        {pillars.map(p => (
                            <div key={p} className={cellClass + " text-gray-500 text-xs"}>
                                {p === 'day' ? <span className="text-cinnabar font-bold text-lg">日主</span> : getTenGod(dayMaster, data[p].gan)}
                            </div>
                        ))}

                        {/* 天干 */}
                        <div className={cellClass + " font-lishu text-lg font-bold"}>天干</div>
                        <div className={cellClass}></div>
                        {pillars.map(p => (
                            <div key={p} className={cellClass}>
                                <span className={`text-2xl font-lishu font-bold ${p === 'day' ? 'text-cinnabar' : 'text-indigo-900'}`}>
                                    {data[p].gan}
                                </span>
                            </div>
                        ))}

                        {/* 地支 */}
                        <div className={cellClass + " font-lishu text-lg font-bold"}>地支</div>
                        <div className={cellClass}></div>
                        {pillars.map(p => {
                             const isKongWang = kongWang.includes(data[p].zhi);
                             return (
                                <div key={p} className={cellClass}>
                                    <span className={`text-2xl font-lishu font-bold text-indigo-900 ${isKongWang ? 'opacity-50' : ''}`}>
                                        {data[p].zhi}
                                    </span>
                                    {isKongWang && <span className="absolute top-0 right-0 text-[10px] bg-gray-200 px-1">空</span>}
                                </div>
                             )
                        })}

                        {/* 藏干 (本气/余气/藏干) */}
                        <div className={cellClass + " font-bold text-gray-500"}>藏干</div>
                        <div className={cellClass}></div>
                        {pillars.map(p => (
                            <div key={p} className={cellClass + " text-xs items-start pl-4"}>
                                {ZHI_HIDDEN[data[p].zhi].map((h, idx) => (
                                    <div key={idx} className="flex gap-1 w-full text-left">
                                        <span className={`font-bold ${idx===0?'text-black':'text-gray-400'}`}>{h.gan}</span>
                                        <span className="scale-75 origin-left text-gray-500">[{getTenGod(dayMaster, h.gan)}]</span>
                                    </div>
                                ))}
                            </div>
                        ))}

                        {/* 纳音 */}
                        <div className={cellClass + " font-bold text-gray-500"}>纳音</div>
                        <div className={cellClass}></div>
                        {pillars.map(p => (
                            <div key={p} className={cellClass}>
                                <span className="vertical-text text-gray-600 text-xs h-16">{NA_YIN[data[p].gan + data[p].zhi]}</span>
                            </div>
                        ))}

                        {/* 神煞 (模拟) */}
                        <div className={cellClass + " font-bold text-gray-500"}>神煞</div>
                        <div className={cellClass}></div>
                        {pillars.map(p => {
                            // 简单的神煞模拟
                            let shens = [];
                            if (data[p].zhi === '子' && dayMaster === '壬') shens.push('羊刃');
                            if (data[p].zhi === '午' && (dayMaster === '丙' || dayMaster === '戊')) shens.push('羊刃');
                            if (['子','午','卯','酉'].includes(data[p].zhi)) shens.push('桃花');
                            if (['辰','戌','丑','未'].includes(data[p].zhi)) shens.push('华盖');
                            if (['寅','申','巳','亥'].includes(data[p].zhi)) shens.push('驿马');
                            
                            // 天乙贵人逻辑模拟
                            if ((dayMaster === '甲' || dayMaster === '戊') && (data[p].zhi === '丑' || data[p].zhi === '未')) shens.push('天乙');
                            
                            return (
                                <div key={p} className={cellClass + " text-[10px]"}>
                                    {shens.map(s => (
                                        <span key={s} className={`block mb-1 px-1 rounded ${s==='天乙'?'bg-cinnabar text-white':'bg-gray-100 text-gray-600'}`}>
                                            {s}
                                        </span>
                                    ))}
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const AnalysisSection = ({ data, userInfo }) => {
            if (!data) return null;
            
            // 基础信息提取
            const dayMaster = data.day.gan;
            const monthZhi = data.month.zhi;
            const dayZhi = data.day.zhi;
            const isMale = userInfo.gender === 'male';
            
            // --- 动态计算五行与笔画 ---
            const dayEl = getFiveElement(dayMaster);
            const nameTotalStrokes = getSimulatedStrokes(userInfo.name);
            const yiGua = calculateNameYi(userInfo.name, nameTotalStrokes, dayEl);

            // --- 1. 事业格局深度逻辑 ---
            // 判断月令本气
            const monthZhiMainGan = ZHI_HIDDEN[monthZhi][0].gan;
            const monthTenGod = getTenGod(dayMaster, monthZhiMainGan); // 月令格局核心
            
            // 强弱判断 (简化版：得月令或得地)
            const isStrong = ['寅','卯'].includes(monthZhi) && ['甲','乙'].includes(dayMaster) ||
                            ['巳','午'].includes(monthZhi) && ['丙','丁'].includes(dayMaster) ||
                            ['申','酉'].includes(monthZhi) && ['庚','辛'].includes(dayMaster) ||
                            ['亥','子'].includes(monthZhi) && ['壬','癸'].includes(dayMaster) ||
                            ['辰','戌','丑','未'].includes(monthZhi) && ['戊','己'].includes(dayMaster);
            
            let careerAdvice = "";
            let patternDesc = "";

            // 根据月令十神定格局描述
            if(monthTenGod.includes('官')) {
                patternDesc = "此造月令正官，为人正直负责，行事稳重，有极强的自律性和管理能力。";
                careerAdvice = "适合在体制内、大型企业、行政管理等稳定性高的领域发展。若官星透干，更易获得职级晋升。";
            } else if(monthTenGod.includes('杀')) {
                patternDesc = "月令七杀，性格果断坚毅，有魄力，不畏艰难，具备开创精神。";
                careerAdvice = "适合军警、司法、创业、市场开拓或具有挑战性的工作。职业生涯早期多波折，但成就往往惊人。";
            } else if(monthTenGod.includes('财')) {
                patternDesc = "月令财星，现实务实，商业嗅觉敏锐，善于理财和资源整合。";
                careerAdvice = "适合金融、贸易、销售、会计或自主经商。若身旺能担财，则富贵可期；若身弱则需防财多压身，宜合伙求财。";
            } else if(monthTenGod.includes('印')) {
                patternDesc = "月令印星，慈悲善良，重名誉，喜学习，有深厚的文化底蕴或专业技能。";
                careerAdvice = "适合教育、学术、研究、咨询、医疗或文化传媒行业。贵人运强，多得长辈或上司提携。";
            } else if(monthTenGod.includes('食') || monthTenGod.includes('伤')) {
                patternDesc = "月令食伤，才华横溢，思维活跃，崇尚自由，不喜拘束，有独特的表现力。";
                careerAdvice = "适合艺术、设计、技术研发、演艺、营销策划等需要创意和技能的行业。不宜从事过于刻板的行政工作。";
            } else {
                patternDesc = "月令比劫，意志坚定，自信心强，但个性较为固执，喜竞争。";
                careerAdvice = "适合自由职业、合伙经营、体力主导或竞争性强的业务岗位。需防同辈竞争或财务纠纷。";
            }

            // --- 2. 婚姻家庭深度逻辑 ---
            const spouseStars = isMale ? ['正财', '偏财'] : ['正官', '七杀'];
            // 检查四柱天干是否透出配偶星
            const visibleSpouseStar = [data.year.gan, data.month.gan, data.hour.gan].map(g => getTenGod(dayMaster, g)).find(tg => spouseStars.includes(tg));
            
            // 日支（夫妻宫）特性
            const dayZhiTenGod = getTenGod(dayMaster, ZHI_HIDDEN[dayZhi][0].gan);
            let marriageDesc = "";
            let spouseChar = "";

            // 夫妻宫十神判断
            if(dayZhiTenGod.includes('财')) {
                marriageDesc = isMale ? "男命日坐财星，主妻贤淑得力，能得妻子之财或因妻致富。" : "女命日坐财星，倾向于找经济条件较好或善于理财的配偶，但也可能因财生官而旺夫。";
                spouseChar = "配偶务实精明，善于持家。";
            } else if(dayZhiTenGod.includes('官') || dayZhiTenGod.includes('杀')) {
                marriageDesc = isMale ? "男命日坐官杀，妻管严，妻子性格强势或能力出众。" : "女命日坐官杀，夫星得位，丈夫多为家庭核心，但需防七杀过旺带来的压力。";
                spouseChar = "配偶性格稳重，责任感强，或有些许霸道。";
            } else if(dayZhiTenGod.includes('印')) {
                marriageDesc = "日坐印星，配偶仁慈宽厚，对自己多有呵护照顾，如同长辈般关怀。";
                spouseChar = "配偶性格温和，有涵养，但可能略显依赖或行动力不足。";
            } else if(dayZhiTenGod.includes('食') || dayZhiTenGod.includes('伤')) {
                marriageDesc = isMale ? "男命日坐食伤，对妻子疼爱有加，但也容易情绪化。" : "女命日坐食伤，克夫之象，对丈夫要求过高或挑剔，易引发口角。";
                spouseChar = "配偶聪明伶俐，才华出众，长相多清秀，但情绪起伏较大。";
            } else {
                marriageDesc = "日坐比劫，夫妻之间更像朋友或合作伙伴，但也容易固执己见，互不相让，多有争吵。";
                spouseChar = "配偶个性刚强，主观意识强，行事果断。";
            }

            // --- 3. 姓名深度逻辑 ---
            // 模拟数理灵动 (简化版)
            let strokeLucky = "中平";
            let strokeDesc = "此数理半吉半凶，运势浮沉不定，需依个人努力而定。";
            const luckyStrokes = [1,3,5,6,7,8,11,13,15,16,21,23,24,25,31,32,33,35,37,39,41,45,47,48,52];
            if(luckyStrokes.includes(nameTotalStrokes % 81)) {
                strokeLucky = "大吉";
                strokeDesc = "此数理为首领运格，天赋吉运，甚至能点石成金，利于事业开创与功名成就。";
            }

            // --- 4. 未来三年流年逻辑 ---
            const currentYear = new Date().getFullYear();
            const futureYears = [];
            for (let i = 0; i < 3; i++) {
                const y = currentYear + i;
                const offset = y - 1900;
                const ganStr = GAN[(6 + offset) % 10]; // 1900 庚
                const zhiStr = ZHI[(0 + offset) % 12]; // 1900 子
                const tenGod = getTenGod(dayMaster, ganStr);
                
                let advice = "";
                // 简单的流年建议生成
                if(tenGod.includes('财')) advice = "流年见财，利于投资理财、拓展业务。上班族可争取加薪，经商者商机增多。男命桃花运旺，单身者宜把握。需防财多坏印，注意长辈健康。";
                else if(tenGod.includes('官') || tenGod.includes('杀')) advice = "官杀克身，压力与机遇并存。利于考公、升职考核、获取名誉。女命感情运佳。若身弱则需防小人是非，注意休息，避免过劳。";
                else if(tenGod.includes('印')) advice = "印星生身，利于学习进修、考证获誉、置办房产。贵人运强，多得长辈提携。心态趋于平和，宜静不宜动，不宜盲目扩张投资。";
                else if(tenGod.includes('食') || tenGod.includes('伤')) advice = "食伤泄秀，思维活跃，才华发挥。利于创作、设计、技艺提升。但言多必失，职场中需谨言慎行，防口舌是非。";
                else advice = "比劫夺财，利于结交朋友、拓展人脉、合作共赢。但财运起伏大，容易破财，不宜借贷担保。感情上需防第三者或竞争关系。";

                futureYears.push({ year: y, gan: ganStr, zhi: zhiStr, tenGod, advice });
            }

            return (
                <div className="mt-6 grid grid-cols-1 gap-8">
                    {/* 1. 事业格局 (扩充) */}
                    <div className="vintage-border bg-white/90 p-6 relative">
                        <h3 className="font-lishu text-2xl text-indigo-900 border-b border-gold mb-4 flex items-center">
                            <span className="w-2 h-6 bg-cinnabar mr-3"></span>
                            事业格局分析
                        </h3>
                        <div className="space-y-4 text-gray-700 leading-relaxed text-justify">
                            <p>
                                <span className="font-bold text-indigo-900">【命局定性】</span>
                                日主<span className="font-bold text-cinnabar">{dayMaster}</span>（五行属{dayEl}），生于{data.month.zhi}月。
                                {patternDesc}
                                全局气势判定为<span className="font-bold">{isStrong ? '身旺' : '身弱'}</span>。
                            </p>
                            <p>
                                <span className="font-bold text-indigo-900">【行业指引】</span>
                                建议从事五行属<span className="font-bold text-cinnabar">{dayEl === '木' ? '火、土' : (dayEl === '火' ? '土、金' : (dayEl === '土' ? '金、水' : (dayEl === '金' ? '水、木' : '木、火')))}</span>之行业。
                                {dayEl === '木' ? '如能源、餐饮、建筑、房地产等。' : 
                                 dayEl === '火' ? '如房地产、农牧、五金、金融等。' :
                                 dayEl === '土' ? '如金融、珠宝、物流、水产等。' :
                                 dayEl === '金' ? '如水利、运输、林业、纺织等。' :
                                 '如教育、出版、光电、IT互联网等。'}
                            </p>
                            <p>
                                <span className="font-bold text-indigo-900">【发展建议】</span>
                                {careerAdvice}
                            </p>
                        </div>
                    </div>

                    {/* 2. 婚姻家庭 (扩充) */}
                    <div className="vintage-border bg-white/90 p-6 relative">
                        <h3 className="font-lishu text-2xl text-indigo-900 border-b border-gold mb-4 flex items-center">
                            <span className="w-2 h-6 bg-indigo-900 mr-3"></span>
                            婚姻情感剖析
                        </h3>
                        <div className="space-y-4 text-gray-700 leading-relaxed text-justify">
                            <p>
                                <span className="font-bold text-indigo-900">【配偶星缘】</span>
                                {isMale ? '乾造' : '坤造'}以<span className="font-bold text-indigo-900">{isMale ? '财星' : '官杀'}</span>为配偶星。
                                {visibleSpouseStar ? `命局天干透出${visibleSpouseStar}，代表异性缘分较明显，感情机会多，容易早恋或早婚。` : '天干不显配偶星，感情多藏于地支或流年大运中，缘分来得较晚，或倾向于晚婚，感情生活平淡。'}
                            </p>
                            <p>
                                <span className="font-bold text-indigo-900">【夫妻宫像】</span>
                                日支夫妻宫坐<span className="font-bold text-cinnabar">{dayZhi}</span>。
                                {marriageDesc}
                            </p>
                            <p>
                                <span className="font-bold text-indigo-900">【伴侣画像】</span>
                                {spouseChar}
                                {['子','午','卯','酉'].includes(dayZhi) ? '且配偶多为气质佳、相貌端庄之人，桃花较旺。' : 
                                 ['寅','申','巳','亥'].includes(dayZhi) ? '且配偶多为聪明能干、奔波劳碌或异地之人。' : 
                                 '且配偶多为敦厚老实、相貌朴素、家庭观念重之人。'}
                            </p>
                        </div>
                    </div>

                    {/* 3. 易卦姓名 (扩充) */}
                    <div className="vintage-border bg-white/90 p-6 relative">
                        <h3 className="font-lishu text-2xl text-indigo-900 border-b border-gold mb-4 flex items-center">
                            <span className="w-2 h-6 bg-indigo-900 mr-3"></span>
                            易卦姓名与数理
                        </h3>
                        <div className="flex flex-col md:flex-row gap-8">
                            <div className="flex-shrink-0 text-center md:border-r border-indigo-100 md:pr-8">
                                <div className="text-6xl font-lishu text-cinnabar mb-2">{yiGua.gua}</div>
                                <div className="text-sm bg-indigo-50 px-3 py-1 rounded inline-block text-indigo-900 mb-2">五行: {yiGua.five}</div>
                                <div className="text-xs text-gray-500">变爻: 六{yiGua.yao}</div>
                            </div>
                            <div className="flex-1 space-y-3 text-sm text-gray-700 leading-relaxed">
                                <p><span className="font-bold text-indigo-900">【卦象辞意】</span>{yiGua.desc}</p>
                                <p>
                                    <span className="font-bold text-indigo-900">【五行生克】</span>
                                    此卦五行属{yiGua.five}，与日主{dayMaster}({dayEl})形成
                                    <span className={yiGua.luck.includes('吉') ? 'text-cinnabar font-bold' : 'text-gray-600'}>
                                        {yiGua.luck.split(' ')[0]}
                                    </span>关系。
                                    {yiGua.luck.includes('吉') ? '卦气生助日主，名字能为命主带来正向的能量磁场，辅助运势提升。' : '卦气与日主相克或耗泄，名字助力稍弱，需靠后天努力补足。'}
                                </p>
                                <p>
                                    <span className="font-bold text-indigo-900">【数理灵动】</span>
                                    总格笔画<span className="font-bold text-cinnabar">{nameTotalStrokes}</span>画。
                                    <span className="font-bold">{strokeLucky}。</span>
                                    {strokeDesc}
                                </p>
                            </div>
                        </div>
                    </div>

                    {/* 4. 未来三年运势 (扩充) */}
                    <div className="vintage-border bg-white/90 p-6 relative">
                        <h3 className="font-lishu text-2xl text-indigo-900 border-b border-gold mb-4 flex items-center">
                            <span className="w-2 h-6 bg-cinnabar mr-3"></span>
                            未来三年运势走向
                        </h3>
                        <div className="space-y-6">
                            {futureYears.map(item => (
                                <div key={item.year} className="flex flex-col md:flex-row gap-4 border-b border-gray-100 pb-4 last:border-0 last:pb-0">
                                    <div className="md:w-32 flex-shrink-0">
                                        <div className="font-bold text-indigo-900 font-lishu text-2xl">{item.year}</div>
                                        <div className="flex items-center gap-2 mt-1">
                                            <span className="bg-indigo-900 text-gold text-xs px-2 py-0.5 rounded">{item.gan}{item.zhi}年</span>
                                            <span className="text-xs border border-cinnabar text-cinnabar px-1 rounded">流年{item.tenGod}</span>
                                        </div>
                                    </div>
                                    <div className="flex-1">
                                        <p className="text-sm text-gray-800 leading-relaxed">
                                            <span className="font-bold text-indigo-900">【运程总述】</span>
                                            {item.advice}
                                        </p>
                                        <p className="text-xs text-gray-500 mt-2">
                                            提示：流年运势仅供参考，具体应结合大运及流月综合推断。
                                        </p>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            )
        }

        // 新增：联系方式组件
        const ContactSection = () => {
            return (
                <div className="mt-6 vintage-border bg-white/90 p-6 relative overflow-hidden">
                     {/* 背景纹理装饰 */}
                    <div className="absolute top-0 right-0 opacity-5 pointer-events-none transform translate-x-10 -translate-y-10">
                        <svg width="150" height="150" viewBox="0 0 100 100" fill="var(--color-indigo)">
                            <path d="M50 0 C20 0 0 20 0 50 C0 80 20 100 50 100 C80 100 100 80 100 50 C100 20 80 0 50 0 Z M50 90 C30 90 10 70 10 50 C10 30 30 10 50 10 C70 10 90 30 90 50 C90 70 70 90 50 90 Z" />
                        </svg>
                    </div>

                    <div className="flex flex-col md:flex-row items-center justify-center gap-8 px-2 relative z-10">
                        <div className="flex-1 text-center md:text-left space-y-3">
                            <h3 className="font-lishu text-2xl text-indigo-900 flex items-center justify-center md:justify-start">
                                <span className="w-2 h-6 bg-cinnabar mr-3 hidden md:block"></span>
                                深度命理咨询
                            </h3>
                            <div className="w-16 h-[2px] bg-gold mx-auto md:mx-0 mb-2"></div>
                            <p className="text-gray-700 text-sm leading-loose">
                                <span className="line-through text-gray-400 hidden">电脑</span>排盘仅为数理基础，若您希望<span className="font-bold text-cinnabar">详细了解自己的八字</span>格局，
                                或针对<span className="text-indigo-900 font-bold">流年运势、事业财运、婚姻情感</span>有具体困惑，
                                欢迎扫码联系<span className="font-bold text-lg text-indigo-900 mx-1 border-b border-gold">扇子老师助理</span>进行一对一专业讲解。
                            </p>
                        </div>
                        
                        <div className="flex flex-col items-center group">
                            <div className="relative p-2 border border-gold rounded bg-white shadow-md transition-all duration-300 hover:shadow-xl hover:border-cinnabar">
                                <img 
                                    src="https://linweijie666-123.github.io/erweima.png" 
                                    alt="扇子老师助理二维码" 
                                    className="w-32 h-32 object-contain rounded-sm"
                                />
                                {/* 四角装饰 */}
                                <div className="absolute top-0 left-0 w-2 h-2 border-t-2 border-l-2 border-indigo-900"></div>
                                <div className="absolute top-0 right-0 w-2 h-2 border-t-2 border-r-2 border-indigo-900"></div>
                                <div className="absolute bottom-0 left-0 w-2 h-2 border-b-2 border-l-2 border-indigo-900"></div>
                                <div className="absolute bottom-0 right-0 w-2 h-2 border-b-2 border-r-2 border-indigo-900"></div>
                            </div>
                            <span className="mt-2 text-xs font-bold text-white bg-indigo-900 px-3 py-0.5 rounded-full shadow">
                                微信扫码咨询
                            </span>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [result, setResult] = React.useState(null);
            const [userInfo, setUserInfo] = React.useState(null);

            const handleCalculate = (info) => {
                const res = calculateBazi(info.date, parseInt(info.time), info.gender, false);
                setResult(res);
                setUserInfo(info);
            };

            return (
                <div className="max-w-4xl mx-auto p-4 md:p-8 min-h-screen">
                    <header className="text-center mb-8">
                        <h1 className="font-lishu text-4xl md:text-5xl text-cinnabar mb-2 drop-shadow-sm">黑扇子八字排盘</h1>
                        <div className="flex justify-center items-center gap-2 text-indigo-900 text-sm">
                            <span className="h-[1px] w-8 bg-indigo-900"></span>
                            <span>子平真诠 · 穷通宝鉴 · 滴天髓</span>
                            <span className="h-[1px] w-8 bg-indigo-900"></span>
                        </div>
                    </header>

                    <InputSection onCalculate={handleCalculate} />
                    
                    {result && (
                        <div className="animate-fade-in">
                            <BaziChart data={result} userInfo={userInfo} />
                            <AnalysisSection data={result} userInfo={userInfo} />
                            <ContactSection />
                        </div>
                    )}

                    <footer className="text-center mt-12 text-xs text-gray-500 font-lishu">
                        <p>© 2025 黑扇子八字排盘系统 | 易经数理分析</p>
                        <p className="mt-1">八字排盘仅供参考</p>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.8s ease-out forwards;
        }
    </style>
</body>
</html>
