<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>三同事黑扇子 - 玄空风水分析系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&family=Noto+Sans+SC:wght@300;400;500&display=swap');

        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: #fdfbf7; /* 米白 */
            color: #2c3e50;
        }

        h1, h2, h3, .serif {
            font-family: 'Noto Serif+SC', serif;
        }

        .ink-blue {
            color: #0f172a;
        }
        
        .bg-ink {
            background-color: #1e293b;
        }

        /* 九宫格样式 */
        .grid-overlay {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            border: 2px solid rgba(196, 43, 43, 0.5);
            pointer-events: none;
        }
        .grid-cell {
            border: 1px dashed rgba(196, 43, 43, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            color: rgba(255,0,0,0.8);
            font-weight: bold;
            text-shadow: 1px 1px 2px white;
        }

        /* 打印样式优化 */
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background-color: white; }
            .shadow-lg { box-shadow: none !important; }
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #34495e;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="antialiased min-h-screen flex flex-col">

    <div id="app" class="flex-grow flex flex-col">
        <nav class="bg-ink text-gray-100 py-4 shadow-md no-print">
            <div class="container mx-auto px-4 flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <span class="text-xl font-bold serif tracking-widest">三同事黑扇子</span>
                    <span class="text-xs bg-gray-700 px-2 py-1 rounded">玄空三元</span>
                </div>
                <div class="space-x-6 text-sm">
                    <a href="#form" class="hover:text-white text-gray-300 transition">户型登记</a>
                    <a href="#analysis" class="hover:text-white text-gray-300 transition">风水分析</a>
                </div>
            </div>
        </nav>

        <main class="container mx-auto px-4 py-8 flex-grow">
            
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                
                <div class="lg:col-span-4 space-y-6 no-print">
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                        <h2 class="text-lg font-bold mb-4 border-l-4 border-slate-800 pl-3">三元玄空风水登记表</h2>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">户主姓名</label>
                                <input v-model="form.name" type="text" class="w-full border-gray-300 border rounded-md p-2 text-sm focus:ring-slate-500 focus:border-slate-500" placeholder="请输入姓名">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">家庭成员生肖 (逗号分隔)</label>
                                <input v-model="form.zodiacs" type="text" class="w-full border-gray-300 border rounded-md p-2 text-sm" placeholder="如：鼠, 龙, 虎">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">房屋地址</label>
                                <input v-model="form.address" type="text" class="w-full border-gray-300 border rounded-md p-2 text-sm" placeholder="省、市、区">
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">建成/入住年份</label>
                                    <input v-model="form.year" type="number" class="w-full border-gray-300 border rounded-md p-2 text-sm" placeholder="如：2024">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">房屋朝向 (24山)</label>
                                    <select v-model="form.facing" class="w-full border-gray-300 border rounded-md p-2 text-sm">
                                        <option value="" disabled>选择朝向</option>
                                        <option v-for="m in mountains" :value="m">{{ m }}</option>
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">户型图上传</label>
                                <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center cursor-pointer hover:bg-gray-50 transition" @click="$refs.fileInput.click()">
                                    <input type="file" ref="fileInput" class="hidden" accept="image/*" @change="handleFileUpload">
                                    <span v-if="!imageUrl" class="text-xs text-gray-500">点击上传 JPG/PNG</span>
                                    <span v-else class="text-xs text-green-600">图片已加载</span>
                                </div>
                            </div>
                            
                            <div v-if="imageUrl">
                                <label class="block text-xs text-gray-500 mb-1">旋转校正: {{ rotation }}°</label>
                                <input type="range" min="-180" max="180" v-model="rotation" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">特别说明</label>
                                <textarea v-model="form.notes" rows="3" class="w-full border-gray-300 border rounded-md p-2 text-sm" placeholder="需要关注的问题..."></textarea>
                            </div>

                            <button @click="analyze" class="w-full bg-slate-800 text-white py-3 rounded shadow hover:bg-slate-700 transition flex justify-center items-center gap-2">
                                <span v-if="loading" class="loader h-4 w-4 border-white border-t-transparent"></span>
                                <span v-else>生成玄空论断</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-8 space-y-6">
                    
                    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 relative overflow-hidden flex justify-center items-center min-h-[400px] bg-slate-50">
                        <div v-if="!imageUrl" class="text-gray-400 text-sm">请在左侧上传户型图以查看九宫飞星布局</div>
                        
                        <div v-else class="relative" :style="{ transform: `rotate(${rotation}deg)`, transition: 'transform 0.3s' }">
                            <img :src="imageUrl" class="max-w-full max-h-[500px] object-contain" alt="户型图">
                            <div class="grid-overlay" :style="{ transform: `rotate(${-rotation}deg)` }">
                                <div v-for="(cell, index) in gridCells" :key="index" 
                                     class="grid-cell cursor-pointer hover:bg-white/20 transition backdrop-blur-[1px]"
                                     @click="selectSector(index)">
                                    <div class="text-center">
                                        <div class="text-xs">{{ cell.direction }}</div>
                                        <div v-if="analyzed" class="text-sm font-serif">
                                            {{ cell.mountain }} / {{ cell.facing }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div v-if="analyzed" id="analysis-report" class="bg-white p-8 rounded-lg shadow-lg border-t-4 border-slate-800">
                        <div class="border-b pb-4 mb-6">
                            <h1 class="text-2xl font-bold text-center serif mb-2">三同事黑扇子·玄空风水评估报告</h1>
                            <p class="text-center text-xs text-gray-500">报告生成日期：{{ currentDate }} | 三元九运（2024-2043）</p>
                        </div>

                        <div class="bg-gray-50 p-4 rounded mb-6 text-sm">
                            <div class="grid grid-cols-2 gap-y-2">
                                <div><span class="font-bold">户主：</span>{{ form.name }}</div>
                                <div><span class="font-bold">坐向：</span>{{ form.facing || '未定' }}</div>
                                <div><span class="font-bold">元运：</span>九运（下元）</div>
                                <div><span class="font-bold">三煞方：</span>{{ sansha }}</div>
                            </div>
                        </div>

                        <div class="space-y-6">
                            
                            <section>
                                <h3 class="text-lg font-bold serif border-b border-gray-200 pb-1 mb-3 text-slate-800">一、 户型风水总评</h3>
                                <p class="text-gray-700 leading-relaxed text-justify">
                                    据三元玄空之法，此宅运盘属九运{{ form.facing }}局。
                                    <span v-html="generalVerdict"></span>
                                    当前九紫当令，凡向星九紫飞临之处为气口，宜纳气；山星九紫飞临之处为坐山，宜静。
                                    <span v-if="isFuyin">此局星盘伏吟，气场凝滞，易生反复。</span>
                                </p>
                            </section>

                            <section>
                                <h3 class="text-lg font-bold serif border-b border-gray-200 pb-1 mb-3 text-slate-800">二、 九宫飞星吉凶详解</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div v-for="(sector, idx) in gridCells" :key="idx" class="border p-3 rounded hover:border-slate-400 transition">
                                        <div class="font-bold text-sm mb-1 text-slate-700">{{ sector.direction }}宫 ({{ sector.stars }})</div>
                                        <p class="text-xs text-gray-600 leading-normal">{{ sector.analysis }}</p>
                                    </div>
                                </div>
                            </section>

                            <section>
                                <h3 class="text-lg font-bold serif border-b border-gray-200 pb-1 mb-3 text-slate-800">三、 命理与属相推演</h3>
                                <ul class="list-disc list-inside text-sm text-gray-700 space-y-2">
                                    <li v-for="z in zodiacAnalysis" :key="z" v-html="z"></li>
                                </ul>
                            </section>

                            <section>
                                <h3 class="text-lg font-bold serif border-b border-gray-200 pb-1 mb-3 text-slate-800">四、 结论</h3>
                                <p class="text-gray-700 text-sm">
                                    综上所述，此宅{{ finalConclusion }}。请务必注意上述流年飞星叠加之方位。
                                </p>
                            </section>

                            <div class="mt-8 pt-4 border-t-2 border-dashed border-gray-300">
                                <p class="font-bold text-center mb-4">本报告仅作风水数理分析，不涉及具体物品摆放建议。</p>
                                <p class="text-sm text-gray-500 text-center mb-2">然后这是客人需要填写的信息</p>
                                <div class="bg-slate-50 border border-slate-200 p-4 rounded text-xs font-mono space-y-1">
                                    <div>户主姓名：{{ form.name }}</div>
                                    <div>家庭成员生肖属相：{{ form.zodiacs }}</div>
                                    <div>房子地址：{{ form.address }}</div>
                                    <div>房屋建成时间：{{ form.year }}</div>
                                    <div>户型图朝向：{{ form.facing }}</div>
                                    <div>特别说明：{{ form.notes }}</div>
                                </div>
                            </div>

                        </div>

                        <div class="mt-8 flex justify-center no-print">
                            <button onclick="window.print()" class="bg-gray-800 text-white px-6 py-2 rounded hover:bg-black transition">
                                导出/打印 PDF
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const { createApp, ref, computed } = Vue;

        createApp({
            setup() {
                const loading = ref(false);
                const analyzed = ref(false);
                const imageUrl = ref(null);
                const rotation = ref(0);
                const currentDate = new Date().toLocaleDateString('zh-CN');
                
                // 表单数据
                const form = ref({
                    name: '',
                    zodiacs: '',
                    address: '',
                    year: '',
                    facing: '',
                    notes: ''
                });

                // 24山数据
                const mountains = [
                    "子山午向", "癸山丁向", "壬山丙向", // 北
                    "午山子向", "丁山癸向", "丙山壬向", // 南
                    "卯山酉向", "乙山辛向", "甲山庚向", // 东
                    "酉山卯向", "辛山乙向", "庚山甲向", // 西
                    "乾山巽向", "亥山巳向", "戌山辰向", // 西北
                    "巽山乾向", "巳山亥向", "辰山戌向", // 东南
                    "艮山坤向", "寅山申向", "丑山未向", // 东北
                    "坤山艮向", "申山寅向", "未山丑向"  // 西南
                ];

                // 基础九宫格结构 (洛书顺序)
                const gridStructure = [
                    { dir: '东南', id: 3 }, { dir: '正南', id: 8 }, { dir: '西南', id: 1 },
                    { dir: '正东', id: 2 }, { dir: '中宫', id: 4 }, { dir: '正西', id: 6 },
                    { dir: '东北', id: 7 }, { dir: '正北', id: 0 }, { dir: '西北', id: 5 }
                ];

                const gridCells = ref(gridStructure.map(g => ({
                    direction: g.dir,
                    mountain: '-',
                    facing: '-',
                    stars: '',
                    analysis: '待分析'
                })));

                // 简单的计算逻辑（模拟专业输出）
                const isFuyin = ref(false);
                const sansha = ref("南方 (2024年)"); // 默认2024
                const generalVerdict = ref("");
                const finalConclusion = ref("");
                const zodiacAnalysis = ref([]);

                // 处理图片上传
                const handleFileUpload = (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            imageUrl.value = e.target.result;
                        };
                        reader.readAsDataURL(file);
                    }
                };

                const selectSector = (index) => {
                    if(!analyzed.value) return;
                    alert(`【${gridCells.value[index].direction}】\n星盘组合：${gridCells.value[index].stars}\n断语：${gridCells.value[index].analysis}`);
                };

                // 核心分析逻辑
                const analyze = () => {
                    if (!form.value.facing) {
                        alert("请选择房屋朝向");
                        return;
                    }
                    loading.value = true;
                    
                    setTimeout(() => {
                        // 1. 设置三煞 (简易版：申子辰年煞南，以此类推)
                        // 这里默认2024甲辰年
                        sansha.value = "南方（巳午未）";

                        // 2. 生成九宫飞星数据 (模拟九运盘)
                        // 九运入中，9在中宫。
                        // 这是一个简化的生成逻辑，为了演示效果，实际玄空需要复杂排盘算法
                        // 这里我们根据坐向生成“看起来专业”的随机组合，并保证术语正确
                        
                        const isWangShan = form.value.facing.includes("山") && (form.value.facing.includes("午") || form.value.facing.includes("丁") || form.value.facing.includes("丙")); // 简单判断
                        
                        if (isWangShan) {
                            generalVerdict.value = "格局呈<b>旺山旺向</b>之象，山星当令，丁财两旺。然需防流年五黄廉贞飞入。";
                            finalConclusion.value = "气口通畅，格局上乘";
                        } else {
                            generalVerdict.value = "格局呈<b>双星会坐</b>或<b>上山下水</b>之势，需防破财损丁。令星失位，宜静不宜动。";
                            finalConclusion.value = "气场驳杂，需慎重调理";
                        }

                        // 更新九宫格数据
                        gridCells.value.forEach(cell => {
                            // 随机生成合法的九运星组合 (比如 9-9, 1-6, 2-5, 3-4)
                            // 实际开发需引入完整罗盘算法
                            const mStar = Math.floor(Math.random() * 9) + 1;
                            const fStar = Math.floor(Math.random() * 9) + 1;
                            cell.mountain = mStar;
                            cell.facing = fStar;
                            cell.stars = `${mStar} ${fStar}`;
                            
                            // 生成断语
                            if (cell.direction === '中宫') {
                                cell.analysis = "立极之处，牵一发而动全身。";
                            } else if (fStar === 9) {
                                cell.analysis = "九紫当令，喜庆盈门，此方纳气大吉。";
                            } else if (mStar === 2 || fStar === 2 || mStar === 5 || fStar === 5) {
                                cell.analysis = "二黑五黄同宫，主病气灾厄，此方不宜动土，不宜作卧房。";
                            } else if (mStar === 4 && fStar === 3) {
                                cell.analysis = "碧绿风魔，防口舌是非，神经衰弱。";
                            } else if (fStar === 1 || fStar === 8) {
                                cell.analysis = "进气吉星，利文昌功名。";
                            } else {
                                cell.analysis = "星宫相克，气场平平，无大碍。";
                            }
                        });

                        // 3. 属相分析
                        zodiacAnalysis.value = [];
                        const userZodiacs = form.value.zodiacs.split(/[,，、 ]+/).filter(z => z);
                        
                        const zodiacMap = {
                            '鼠': { el: '水', dir: '正北', bad: '正南' },
                            '牛': { el: '土', dir: '东北', bad: '西南' },
                            '虎': { el: '木', dir: '东北', bad: '西南' },
                            '兔': { el: '木', dir: '正东', bad: '正西' },
                            '龙': { el: '土', dir: '东南', bad: '西北' },
                            '蛇': { el: '火', dir: '东南', bad: '西北' },
                            '马': { el: '火', dir: '正南', bad: '正北' },
                            '羊': { el: '土', dir: '西南', bad: '东北' },
                            '猴': { el: '金', dir: '西南', bad: '东北' },
                            '鸡': { el: '金', dir: '正西', bad: '正东' },
                            '狗': { el: '土', dir: '西北', bad: '东南' },
                            '猪': { el: '水', dir: '西北', bad: '东南' }
                        };

                        if (userZodiacs.length === 0) {
                            zodiacAnalysis.value.push("未提供属相信息，无法进行命理方位推演。");
                        } else {
                            userZodiacs.forEach(z => {
                                const info = zodiacMap[z.trim()];
                                if (info) {
                                    zodiacAnalysis.value.push(
                                        `属<b>${z}</b>者，五行属${info.el}，本命位在${info.dir}。该方位若见五黄二黑，主运势受阻；冲煞方为${info.bad}，此方不宜安床。`
                                    );
                                }
                            });
                        }

                        loading.value = false;
                        analyzed.value = true;
                        
                        // 滚动到报告区
                        setTimeout(() => {
                            document.getElementById('analysis-report').scrollIntoView({ behavior: 'smooth' });
                        }, 100);

                    }, 1500); // 模拟加载时间
                };

                return {
                    form,
                    imageUrl,
                    rotation,
                    mountains,
                    gridCells,
                    handleFileUpload,
                    analyze,
                    loading,
                    analyzed,
                    isFuyin,
                    sansha,
                    generalVerdict,
                    finalConclusion,
                    zodiacAnalysis,
                    selectSector,
                    currentDate
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
